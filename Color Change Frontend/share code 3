class Star:
    def __init__(self, index, color, duration):
        self.index = index
        self.r, self.g, self.b = color
        self.duration = duration  # Total time for one cycle
        self.brightness = 0
        self.active = True

    async def sparkle(self):
        step_time = 0.05
        steps = int(self.duration / step_time / 2)

        # كل نجمة تنتظر بشكل عشوائي قبل أول لمعان
        await asyncio.sleep(random.uniform(0, 4))

        while self.active:
            # Fade in
            for i in range(steps):
                if not self.active:
                    return
                self.brightness = int(255 * (i / steps))
                neo.set_led_color(self.index,
                                  (self.r * self.brightness) // 255,
                                  (self.g * self.brightness) // 255,
                                  (self.b * self.brightness) // 255)
                await asyncio.sleep(step_time)

            await asyncio.sleep(random.uniform(0.1, 0.4))

            # Fade out
            for i in range(steps):
                if not self.active:
                    return
                self.brightness = int(255 * ((steps - i) / steps))
                neo.set_led_color(self.index,
                                  (self.r * self.brightness) // 255,
                                  (self.g * self.brightness) // 255,
                                  (self.b * self.brightness) // 255)
                await asyncio.sleep(step_time)

            neo.set_led_color(self.index, 0, 0, 0)

            # راحة عشوائية بين الدورات
            await asyncio.sleep(random.uniform(0.5, 2))

async def custom_sparkling_stars_loop(hex_color: str):
    global stop_requested
    neo.clear_strip()
    neo.update_strip()

    r = int(hex_color[1:3], 16)
    g = int(hex_color[3:5], 16)
    b = int(hex_color[5:7], 16)

    stars = []
    tasks = []

    while not stop_requested:
        if len(stars) < 80:
            # أماكن غير مستخدمة
            used_indexes = [s.index for s in stars]
            available_indexes = [i for i in range(NUM_LEDS) if i not in used_indexes]
            if available_indexes:
                idx = random.choice(available_indexes)
                duration = random.uniform(1.5, 3.5)
                star = Star(idx, (r, g, b), duration)
                stars.append(star)
                tasks.append(asyncio.create_task(star.sparkle()))

        await asyncio.sleep(0.1)

    # إيقاف الأنميشن عند الطلب
    for star in stars:
        star.active = False
    await asyncio.gather(*tasks)
    neo.clear_strip()
    neo.update_strip()
