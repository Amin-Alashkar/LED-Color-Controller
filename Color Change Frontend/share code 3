async def pulse_sync_loop(delay: float = 0.03, steps: int = 20):
    global stop_requested

    # دالة لتوليد ألوان عشوائية
    def get_random_color():
        return (
            random.randint(50, 255),   # الأحمر
            random.randint(50, 255),   # الأخضر  
            random.randint(50, 255)    # الأزرق
        )

    position = 0
    direction = 1
    # طول عشوائي بين 10 و30
    trail_length = random.randint(10, 30)
    # لون عشوائي بداية
    r_base, g_base, b_base = get_random_color()

    while not stop_requested:
        neo.clear_strip()

        # رسم الرأس والذيل
        for t in range(trail_length):
            pos = position - (t * direction)
            if 0 <= pos < NUM_LEDS:
                factor = (trail_length - t) / trail_length
                r = int(r_base * factor)
                g = int(g_base * factor)
                b = int(b_base * factor)
                neo.set_led_color(
                    pos,
                    int(r * BRIGHTNESS_SCALE),
                    int(g * BRIGHTNESS_SCALE),
                    int(b * BRIGHTNESS_SCALE)
                )

        neo.update_strip()
        await asyncio.sleep(delay)

        position += direction

        # إذا وصل الطرف:
        if position >= NUM_LEDS - 1 or position <= 0:
            # يبقى الرأس فقط مضيء والباقي يتلاشى
            for i in range(trail_length):
                neo.clear_strip()

                # فقط الرأس يبقى، الباقي يتلاشى
                for t in range(trail_length - i):
                    pos = position - (t * direction)
                    if 0 <= pos < NUM_LEDS:
                        factor = (trail_length - i - t) / trail_length
                        r = int(r_base * factor)
                        g = int(g_base * factor)
                        b = int(b_base * factor)
                        neo.set_led_color(
                            pos,
                            int(r * BRIGHTNESS_SCALE),
                            int(g * BRIGHTNESS_SCALE),
                            int(b * BRIGHTNESS_SCALE)
                        )
                neo.update_strip()
                await asyncio.sleep(delay)

            # بعد ما الرأس يضل لحاله → نغير اللون والطول
            r_base, g_base, b_base = get_random_color()
            trail_length = random.randint(10, 30)  # طول عشوائي جديد

            # عكس الاتجاه
            direction *= -1

    neo.clear_strip()
    neo.update_strip()
