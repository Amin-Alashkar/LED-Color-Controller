
from typing import Annotated
from fastapi import Depends, FastAPI, HTTPException
from sqlmodel import Field, Session, SQLModel, create_engine, select

# 1. تعريف الموديل
class User(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    username: str = Field(index=True, unique=True)
    password: str  # عادي نص plain الآن للتجريب (بس بالمستقبل لازم hashing)

# 2. قاعدة البيانات
sqlite_file_name = "admin.db"
sqlite_url = f"sqlite:///{sqlite_file_name}"
engine = create_engine(sqlite_url, connect_args={"check_same_thread": False})

def create_db_and_tables():
    SQLModel.metadata.create_all(engine)

def get_session():
    with Session(engine) as session:
        yield session

SessionDep = Annotated[Session, Depends(get_session)]

# 3. التطبيق
app = FastAPI()

@app.on_event("startup")
def on_startup():
    create_db_and_tables()

# 4. API لإضافة مستخدم (عشان تنشئ admin أول مرة)
@app.post("/users/")
def create_user(user: User, session: SessionDep) -> User:
    session.add(user)
    session.commit()
    session.refresh(user)
    return user

# 5. API لقراءة المستخدمين (اختياري)
@app.get("/users/")
def read_users(session: SessionDep):
    return session.exec(select(User)).all()

# 6. API لتسجيل الدخول
@app.post("/login/")
def login(username: str, password: str, session: SessionDep):
    statement = select(User).where(User.username == username)
    user = session.exec(statement).first()
    if not user or user.password != password:
        raise HTTPException(status_code=401, detail="Invalid credentials")
    return {"isAdmin": True, "username": user.username}
