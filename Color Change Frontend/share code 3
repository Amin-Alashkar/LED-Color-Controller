import time  # نحتاجه للوقت الحقيقي

class Snake:
    def __init__(self, start_pos=0, length=10):
        self.position = start_pos
        self.length = length
        self.done = False

    def get_tail(self):
        return self.position - self.length

    def get_body_indexes(self):
        return [
            idx for idx in range(self.position, self.position - self.length, -1)
            if 0 <= idx < NUM_LEDS
        ]

    def move(self):
        self.position += 1
        if self.get_tail() >= NUM_LEDS:
            self.done = True


async def custom_color_wipe_loop(hex_color: str, delay: float = 0.05):
    global stop_requested

    r = int(hex_color[1:3], 16)
    g = int(hex_color[3:5], 16)
    b = int(hex_color[5:7], 16)

    DIM_LEVEL = 100
    background_color = (
        (r * DIM_LEVEL) // 255,
        (g * DIM_LEVEL) // 255,
        (b * DIM_LEVEL) // 255
    )

    # لون مميز للذيل (مثلاً أبيض أو لون فاتح)
    tail_color = (255, 255, 255)

    # خلفية أولية
    for i in range(NUM_LEDS):
        neo.set_led_color(i, *background_color)
    neo.update_strip()

    snakes = []

    # نظام زمني
    next_snake_time = time.time()

    while not stop_requested:
        current_time = time.time()

        # إضافة ثعبان جديد إذا مر وقت كافي
        if current_time >= next_snake_time:
            snakes.append(Snake(start_pos=0))

            # نحسب وقت الثعبان الجاي
            gap_seconds = random.uniform(0.2, 1.2)  # فرق عشوائي بين 0.2 إلى 1.2 ثانية
            next_snake_time = current_time + gap_seconds

        # تحديث كل ثعبان
        for s in snakes:
            tail_idx = s.get_tail()

            # الخلفية في موضع الذيل السابق
            if 0 <= tail_idx < NUM_LEDS:
                neo.set_led_color(tail_idx, *background_color)

            # جسم الثعبان
            body_indexes = s.get_body_indexes()

            for idx in body_indexes[:-1]:  # كل الجسم عدا الذيل
                neo.set_led_color(idx, r, g, b)

            if body_indexes:  # لون الذيل
                tail = body_indexes[-1]
                neo.set_led_color(tail, *tail_color)

            s.move()

        # إزالة الثعابين المنتهية
        snakes = [s for s in snakes if not s.done]

        neo.update_strip()
        await asyncio.sleep(delay)

    neo.clear_strip()
    neo.update_strip()
