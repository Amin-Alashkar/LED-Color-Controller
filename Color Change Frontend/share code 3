/* === Helper: hex -> "r,g,b" === */
function hexToRgbString(hex) {
  if (!hex) return '0,0,0';
  // strip hash
  hex = hex.replace('#','').trim();
  if (hex.length === 3) {
    hex = hex.split('').map(ch => ch + ch).join('');
  }
  const int = parseInt(hex, 16);
  const r = (int >> 16) & 255;
  const g = (int >> 8) & 255;
  const b = int & 255;
  return `${r},${g},${b}`;
}

/* === set UI color variables used by CSS === */
function setUIColor(hexOrRgb) {
  // Accept either '#rrggbb' or 'rgb(r,g,b)' or 'r,g,b'
  let rgb;
  if (!hexOrRgb) {
    rgb = '0,0,0';
    document.documentElement.style.setProperty('--ui-color', '#000000');
  } else if (hexOrRgb.startsWith('rgb')) {
    // "rgb(r, g, b)" or "rgba(...)"
    const nums = hexOrRgb.replace(/rgba?\(|\)|\s/g,'').split(',').slice(0,3);
    rgb = nums.join(',');
    document.documentElement.style.setProperty('--ui-color', `rgb(${rgb})`);
  } else if (hexOrRgb.indexOf(',') !== -1) {
    rgb = hexOrRgb;
    document.documentElement.style.setProperty('--ui-color', `rgb(${rgb})`);
  } else {
    // hex
    rgb = hexToRgbString(hexOrRgb);
    document.documentElement.style.setProperty('--ui-color', hexOrRgb);
  }
  document.documentElement.style.setProperty('--ui-rgb', rgb);
}

/* === get the current color from the color picker or the color-display === */
function getCurrentColor() {
  const cp = document.getElementById('colorPicker');
  if (cp && cp.value) return cp.value;
  const display = document.getElementById('colorDisplay');
  if (display) {
    const style = window.getComputedStyle(display).backgroundColor;
    if (style) return style;
  }
  return '#00ff00';
}

/* === create and play welcome overlay === */
function playWelcomeOverlay() {
  // remove any existing overlay (safety)
  const existing = document.getElementById('welcomeOverlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'welcomeOverlay';
  overlay.innerHTML = `<div id="welcomeText">Hello ðŸ‘‹</div>`;
  document.body.appendChild(overlay);

  // small delay to allow DOM paint
  requestAnimationFrame(() => {
    // add class to start CSS animation
    overlay.classList.add('play');
  });

  // remove overlay after animation ends (safely)
  overlay.addEventListener('animationend', (e) => {
    // We want to remove after the backdrop animation finishes
    if (e.animationName === 'welcomeBackdrop') {
      overlay.remove();
    }
  });

  // add pulse to color-display
  const display = document.getElementById('colorDisplay');
  if (display) {
    display.classList.add('welcome-pulse');
    setTimeout(() => display.classList.remove('welcome-pulse'), 1400);
  }
}

/* === Run on every load (first load or reload) === */
document.addEventListener('DOMContentLoaded', () => {
  const color = getCurrentColor();
  setUIColor(color);
  // play overlay a little after load so everything looks smooth
  setTimeout(playWelcomeOverlay, 120);
});

/* === IMPORTANT: If you already have changeColor(hex) function,
   add setUIColor(hex) inside it so UI syncs when user presses color buttons ===

Example:
function changeColor(hex) {
  // ... your existing code that updates color-display, sends to LED etc.
  // then add:
  setUIColor(hex);
}
*/
