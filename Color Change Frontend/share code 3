class Snake:
    def __init__(self, start_pos=0, length=10):
        self.position = start_pos
        self.length = length
        self.done = False

    def get_tail(self):
        return self.position - self.length

    def get_body_indexes(self):
        # Ù…Ù† Ø§Ù„Ø±Ø£Ø³ Ù„Ù„Ø°ÙŠÙ„ (Ø·ÙˆÙ„ 10)
        return [
            idx for idx in range(self.position, self.position - self.length, -1)
            if 0 <= idx < NUM_LEDS
        ]

    def move(self):
        self.position += 1
        if self.get_tail() >= NUM_LEDS:
            self.done = True


async def custom_color_wipe_loop(hex_color: str, delay: float = 0.05):
    """
    Final Snake Animation - Super Ghost Mode ğŸ—¿
    - Background at half brightness
    - Infinite snakes (length 10) move startâ†’end
    - Full brightness snakes
    - Tail restores background
    - Random gap between snakes (3â€“10)
    """
    global stop_requested

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù‡ÙƒØ³
    r = int(hex_color[1:3], 16)
    g = int(hex_color[3:5], 16)
    b = int(hex_color[5:7], 16)

    # Ø¥Ø¹Ø¯Ø§Ø¯ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù†ØµÙ Ø§Ù„Ø³Ø·ÙˆØ¹)
    DIM_LEVEL = 100
    background_color = (
        (r * DIM_LEVEL) // 255,
        (g * DIM_LEVEL) // 255,
        (b * DIM_LEVEL) // 255
    )

    # Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£ÙˆÙ„ Ù…Ø±Ø©
    for i in range(NUM_LEDS):
        neo.set_led_color(i, *background_color)
    neo.update_strip()

    snakes = []
    gap_counter = 0
    current_gap = random.randint(3, 10)

    while not stop_requested:
        # Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ²Ù†Ø§ Ø§Ù„ÙØ¬ÙˆØ©ØŒ Ù†Ø·Ù„Ù‚ Ø«Ø¹Ø¨Ø§Ù† Ø¬Ø¯ÙŠØ¯
        if gap_counter <= 0:
            snakes.append(Snake(start_pos=0))
            current_gap = random.randint(3, 10)
            gap_counter = current_gap
        else:
            gap_counter -= 1

        # Ø­Ø¯Ø« ÙƒÙ„ Ø«Ø¹Ø¨Ø§Ù†
        for s in snakes:
            # Ø£Ø±Ø¬Ø¹ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø°ÙŠÙ„
            tail = s.get_tail()
            if 0 <= tail < NUM_LEDS:
                neo.set_led_color(tail, *background_color)

            # Ø£Ø¶Ø¦ Ø¬Ø³Ù… Ø§Ù„Ø«Ø¹Ø¨Ø§Ù†
            for idx in s.get_body_indexes():
                neo.set_led_color(idx, r, g, b)

            s.move()

        # ØµÙÙ‘ÙŠ Ø§Ù„Ø«Ø¹Ø§Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
        snakes = [s for s in snakes if not s.done]

        neo.update_strip()
        await asyncio.sleep(delay)

    # Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ Ù†Ù†Ø¸Ù Ø§Ù„Ø´Ø±ÙŠØ·
    neo.clear_strip()
    neo.update_strip()
