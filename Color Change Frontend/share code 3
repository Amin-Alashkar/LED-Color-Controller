
# ==== أعلى الملف: عدّل ال Models ====
class AnimationRequest(BaseModel):
    animation_type: str
    color_index: int = 0
    hex_color: str | None = None
    # Fade options:
    fade_in: bool = False
    fade_duration_ms: int = 0
    fade_steps: int = 10

class ColorRequest(BaseModel):
    hex_color: str
    fade_in: bool = False
    fade_duration_ms: int = 0
    fade_steps: int = 10


# ==== دالة fade-in مساعدة ====
async def fade_in_color(hex_color: str, duration_ms: int = 600, steps: int = 12):
    """
    Gradually ramp LEDs from off to full (based on hex_color) over duration_ms,
    divided into `steps` steps. Uses BRIGHTNESS_SCALE as in your code.
    """
    global stop_requested
    if not hex_color or not hex_color.startswith("#"):
        return

    r_base = int(hex_color[1:3], 16)
    g_base = int(hex_color[3:5], 16)
    b_base = int(hex_color[5:7], 16)

    if steps <= 0:
        steps = 1
    step_delay = max(0.001, (duration_ms / steps) / 1000.0)

    # from 0..steps inclusive so final is full color
    for step in range(1, steps + 1):
        if stop_requested:
            break
        factor = step / steps
        r = int(r_base * factor)
        g = int(g_base * factor)
        b = int(b_base * factor)
        for i in range(NUM_LEDS):
            neo.set_led_color(
                i,
                int(r * BRIGHTNESS_SCALE),
                int(g * BRIGHTNESS_SCALE),
                int(b * BRIGHTNESS_SCALE)
            )
        neo.update_strip()
        await asyncio.sleep(step_delay)



# ==== ضمن animation_worker(): قبل استدعاء كل أنيميشن، افحص req.fade_in و شغّل fade_in_color إذا لزم ====
async def animation_worker():
    global stop_requested, current_anim
    while True:
        if animation_queue:
            with animation_lock:
                req = animation_queue.popleft()
            stop_requested = False
            current_anim = req.animation_type

            # إذا المستخدم طلب fade-in و أرسَل hex_color، نعمله أولاً
            if getattr(req, "fade_in", False) and getattr(req, "hex_color", None):
                try:
                    await fade_in_color(req.hex_color, getattr(req, "fade_duration_ms", 600), getattr(req, "fade_steps", 12))
                except Exception as e:
                    print("fade_in_color error:", e)

            # بعد الfade-in، نستدعي الأنيميشن المطلوب (بقية الكود كما هو)
            if req.animation_type == "custom_fade":
                if req.hex_color:
                    await custom_fade_loop(req.hex_color)
            # ... (باقي الشيكات كما في كودك) ...
            # مثال: elif req.animation_type == "custom_blink": ...
            # لا تغيّر منطق الأنيميشن نفسه — فقط أضف fade-in فوق.
        await asyncio.sleep(0.1)




# ==== endpoint /color: دعم fade_in عند تغيير لون ثابت ====
@app.post("/color")
async def set_color(req: ColorRequest):
    global current_hex, current_anim, stop_requested
    with animation_lock:
        animation_queue.clear()
        stop_requested = True

        if getattr(req, "fade_in", False):
            # نعمل fade in بدل set فوري
            await fade_in_color(req.hex_color, getattr(req, "fade_duration_ms", 600), getattr(req, "fade_steps", 12))
        else:
            r = int(req.hex_color[1:3], 16)
            g = int(req.hex_color[3:5], 16)
            b = int(req.hex_color[5:7], 16)
            for i in range(NUM_LEDS):
                neo.set_led_color(
                    i,
                    int(r * BRIGHTNESS_SCALE),
                    int(g * BRIGHTNESS_SCALE),
                    int(b * BRIGHTNESS_SCALE)
                )
            neo.update_strip()

    current_anim = None
    current_hex = req.hex_color
    return {"status": "color_changed", "color": req.hex_color}
