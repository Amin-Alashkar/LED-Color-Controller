class Snake:
    def __init__(self, start_pos=0, length=10):
        self.position = start_pos
        self.length = length
        self.done = False

    def get_head(self):
        return self.position

    def get_tail(self):
        return self.position - self.length

    def get_body_indexes(self):
        return [self.position - i for i in range(self.length) if 0 <= self.position - i < NUM_LEDS]

    def move(self):
        self.position += 1
        if self.get_tail() >= NUM_LEDS:
            self.done = True


async def custom_color_wipe_loop(hex_color: str, delay: float = 0.05):
    """
    Super Ghost Mode ğŸ—¿:
    - Ø®Ù„ÙÙŠØ© Ø«Ø§Ø¨ØªØ© Ø¨Ù†ØµÙ Ø§Ù„Ø³Ø·ÙˆØ¹
    - Ø£ÙØ§Ø¹ÙŠ Ø¨Ø·ÙˆÙ„ 10ØŒ ØªÙ…Ø´ÙŠ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ù†Ù‡Ø§ÙŠØ©
    - ÙƒÙ„ Ø£ÙØ¹Ù‰ Ø¨Ø³Ø·ÙˆØ¹ ÙƒØ§Ù…Ù„
    - Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ±Ù‡Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙƒÙ…Ø§ ÙƒØ§Ù†Øª
    - ÙØ¬ÙˆØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙØ§Ø¹ÙŠ (3 Ø¥Ù„Ù‰ 10)
    """
    global stop_requested

    r_base = int(hex_color[1:3], 16)
    g_base = int(hex_color[3:5], 16)
    b_base = int(hex_color[5:7], 16)

    DIM_LEVEL = 100
    background_color = (
        (r_base * DIM_LEVEL) // 255,
        (g_base * DIM_LEVEL) // 255,
        (b_base * DIM_LEVEL) // 255
    )

    # Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø§Ù„Ø¨Ù„Ø§Ø·)
    for i in range(NUM_LEDS):
        neo.set_led_color(i, *background_color)
    neo.update_strip()

    snakes = []
    gap_counter = 0
    current_gap = random.randint(3, 10)

    while not stop_requested:
        if gap_counter >= current_gap:
            snakes.append(Snake())
            gap_counter = 0
            current_gap = random.randint(3, 10)
        else:
            gap_counter += 1

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙØ§Ø¹ÙŠ
        for snake in snakes:
            # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø°ÙŠÙ„ Ù„Ù„Ø®Ù„ÙÙŠØ©
            tail = snake.get_tail()
            if 0 <= tail < NUM_LEDS:
                neo.set_led_color(tail, *background_color)

            # Ø§Ø¶Ø§Ø¡Ø© Ø¬Ø³Ù… Ø§Ù„Ø£ÙØ¹Ù‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            for i in snake.get_body_indexes():
                neo.set_led_color(i, r_base, g_base, b_base)

            # ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø£ÙØ¹Ù‰
            snake.move()

        # Ø­Ø°Ù Ø§Ù„Ø£ÙØ§Ø¹ÙŠ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
        snakes = [s for s in snakes if not s.done]

        neo.update_strip()
        await asyncio.sleep(delay)

    # Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ Ù†Ø¸Ù Ø§Ù„Ø´Ø±ÙŠØ·
    neo.clear_strip()
    neo.update_strip()
