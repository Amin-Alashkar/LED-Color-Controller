
/* === Helper: hex -> "r,g,b" === */
function hexToRgbString(hex) {
  if (!hex) return '0,0,0';
  hex = hex.replace('#','').trim();
  if (hex.length === 3) {
    hex = hex.split('').map(ch => ch + ch).join('');
  }
  const int = parseInt(hex, 16);
  const r = (int >> 16) & 255;
  const g = (int >> 8) & 255;
  const b = int & 255;
  return `${r},${g},${b}`;
}

/* set CSS vars used by the entry animation */
function setUIColor(hexOrRgb) {
  let rgb;
  if (!hexOrRgb) {
    rgb = '0,0,0';
    document.documentElement.style.setProperty('--ui-color', '#000000');
  } else if (hexOrRgb.startsWith('rgb')) {
    const nums = hexOrRgb.replace(/rgba?$begin:math:text$|$end:math:text$|\s/g,'').split(',').slice(0,3);
    rgb = nums.join(',');
    document.documentElement.style.setProperty('--ui-color', `rgb(${rgb})`);
  } else if (hexOrRgb.indexOf(',') !== -1) {
    rgb = hexOrRgb;
    document.documentElement.style.setProperty('--ui-color', `rgb(${rgb})`);
  } else {
    rgb = hexToRgbString(hexOrRgb);
    document.documentElement.style.setProperty('--ui-color', hexOrRgb);
  }
  document.documentElement.style.setProperty('--ui-rgb', rgb);
}

/* get current color (prefers color picker, then display bg, then default) */
function getCurrentColor() {
  const cp = document.getElementById('colorPicker');
  if (cp && cp.value) return cp.value;
  const display = document.getElementById('colorDisplay');
  if (display) {
    const style = window.getComputedStyle(display).backgroundColor;
    if (style) return style;
  }
  return '#00ff00';
}

/* play the card animation (add class, remove after animation so it can retrigger on reload) */
function playCardEntry() {
  const card = document.querySelector('.card');
  if (!card) return;
  // ensure vars are in sync before animation
  setUIColor(getCurrentColor());

  // remove then force reflow to allow re-triggering
  card.classList.remove('card-entry');
  // small tick to ensure class reflow
  void card.offsetWidth;
  card.classList.add('card-entry');

  // cleanup after animation ended (optional but keeps DOM tidy)
  const onAnimEnd = (e) => {
    // only react to our keyframe name roughly (or just remove after a timeout)
    card.classList.remove('card-entry');
    card.removeEventListener('animationend', onAnimEnd);
  };
  card.addEventListener('animationend', onAnimEnd);
}

/* Run on load */
document.addEventListener('DOMContentLoaded', () => {
  // sync UI color and trigger entry
  setUIColor(getCurrentColor());
  // short delay gives browser time to paint before heavy glow
  setTimeout(playCardEntry, 90);
});

/* === IMPORTANT: integrate with your changeColor(hex) ===
   inside your existing function that handles button clicks, add:
   setUIColor(hex);
   so the card glow updates immediately when user presses buttons.
Example:
function changeColor(hex) {
  // ... your existing LED logic, update colorDisplay, send to device ...
  document.getElementById('colorDisplay').style.background = hex;
  // then sync UI vars:
  setUIColor(hex);
}
*/
