class Snake:
    def __init__(self, start_pos=0, length=10):
        self.position = start_pos
        self.length = length
        self.done = False

    def get_tail(self):
        return self.position - self.length

    def get_body_indexes(self):
        # من الرأس إلى الذيل (10 LEDs)
        return [self.position - i for i in range(self.length) if 0 <= self.position - i < NUM_LEDS]

    def move(self):
        self.position += 1
        if self.get_tail() >= NUM_LEDS:
            self.done = True


async def custom_color_wipe_loop(hex_color: str, delay: float = 0.05):
    """
    Final Snake Animation - Super Ghost Mode v1000
    - Background on (dimmed)
    - Snakes move from start to end with full brightness
    - Tail restores background after passing
    - Random gap (3-10) between snakes
    """
    global stop_requested

    # استخراج اللون من الهكس
    r_base = int(hex_color[1:3], 16)
    g_base = int(hex_color[3:5], 16)
    b_base = int(hex_color[5:7], 16)

    # إعدادات السطوع
    DIM_LEVEL = 100  # نصف السطوع للخلفية
    background_color = (
        (r_base * DIM_LEVEL) // 255,
        (g_base * DIM_LEVEL) // 255,
        (b_base * DIM_LEVEL) // 255
    )

    # إضاءة الخلفية أولاً
    for i in range(NUM_LEDS):
        neo.set_led_color(i, *background_color)
    neo.update_strip()

    snakes = []
    gap_counter = 0
    current_gap = random.randint(3, 10)

    while not stop_requested:
        # إضافة أفعى جديدة إذا تحقق الشرط
        if gap_counter <= 0:
            snakes.append(Snake(start_pos=0))
            current_gap = random.randint(3, 10)
            gap_counter = current_gap
        else:
            gap_counter -= 1

        # تحديث حالة كل أفعى
        for snake in snakes:
            # مسح الذيل = إرجاع الخلفية
            tail_index = snake.get_tail()
            if 0 <= tail_index < NUM_LEDS:
                neo.set_led_color(tail_index, *background_color)

            # إضاءة الجسم بالكامل
            for led_index in snake.get_body_indexes():
                neo.set_led_color(led_index, r_base, g_base, b_base)

            # تحريك الأفعى
            snake.move()

        # إزالة الأفاعي اللي خلصت
        snakes = [s for s in snakes if not s.done]

        neo.update_strip()
        await asyncio.sleep(delay)

    # في حال تم الإيقاف
    neo.clear_strip()
    neo.update_strip()
