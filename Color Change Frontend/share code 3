import random

async def meteor_shower_loop(delay_per_step: float = 0.05, min_trail_length: int = 5, max_trail_length: int = 20):
    global stop_requested

    SNAKE_COLORS = [
        (255,   0,   0),   # أحمر
        (  0,   0, 255),   # أزرق
        (  0, 255,   0),   # أخضر
        (255, 255,   0),   # أصفر
        (255,   0, 255),   # أرجواني
        (  0, 255, 255),   # سماوي
        (255, 165,   0),   # برتقالي
        (255, 192, 203),   # وردي
        (138,  43, 226),   # بنفسجي
        ( 50, 205,  50)    # أخضر ليموني
    ]

    while not stop_requested:
        # مسح الشريط
        neo.clear_strip()
        neo.update_strip()

        # قائمة تمثل الأفاعي النشطة حاليًا
        active_snakes = []
        global_frame = 0
        
        # وقت إطلاق الأفعى التالية (يبدأ بإطلاق أول أفعى فورًا)
        next_spawn_time = 0
        last_snake_head_pos = -20  # وضعية تخيلية للأفعى السابقة (خارج النطاق)

        while not stop_requested:
            # إذا حان وقت إطلاق أفعى جديدة ولم نطلب التوقف
            if global_frame >= next_spawn_time and not stop_requested:
                # تحديد تباعد عشوائي عن الأفعى السابقة (3 إلى 15 فراغ)
                min_gap = 3
                max_gap = 15
                
                # إذا كانت هناك أفعى سابقة، نتحقق من التباعد
                if last_snake_head_pos >= 0:
                    current_gap = global_frame - last_snake_head_pos
                    if current_gap < min_gap:
                        # إذا كان التباعد أقل من الحد الأدنى، ننتظر
                        next_spawn_time = global_frame + (min_gap - current_gap)
                    else:
                        # تباعد عشوائي بين min_gap و max_gap
                        gap = random.randint(min_gap, max_gap)
                        next_spawn_time = global_frame + gap
                else:
                    # أول أفعى - نطلقها فورًا
                    gap = 0
                    next_spawn_time = global_frame + gap

                # توليد أفعى عشوائية
                trail_length = random.randint(min_trail_length, max_trail_length)
                color_base = random.choice(SNAKE_COLORS)
                
                # إضافة الأفعى الجديدة
                active_snakes.append({
                    'trail_length': trail_length,
                    'color_base': color_base,
                    'progress': 0,
                    'head_start_frame': global_frame + gap  # توقيت بداية الرأس
                })
                
                last_snake_head_pos = global_frame + gap

            # مسح الشريط
            neo.clear_strip()

            # تحديث ورسم كل الأفاعي النشطة
            snakes_to_remove = []
            
            for snake in active_snakes:
                trail_length = snake['trail_length']
                color_base = snake['color_base']
                progress = snake['progress']
                
                # حساب وضعية الرأس (تبدأ من خارج الشريط وتتحرك داخله)
                head_pos = NUM_LEDS - progress
                
                # رسم ذيل الأفعى
                for t in range(trail_length):
                    pos = head_pos + t
                    if 0 <= pos < NUM_LEDS:
                        # حساب التدريج (فاتح في الرأس، داكن في الذيل)
                        factor = (trail_length - t) / trail_length
                        r = int(color_base[0] * factor)
                        g = int(color_base[1] * factor)
                        b = int(color_base[2] * factor)
                        neo.set_led_color(
                            pos,
                            int(r * BRIGHTNESS_SCALE),
                            int(g * BRIGHTNESS_SCALE),
                            int(b * BRIGHTNESS_SCALE)
                        )
                
                # تحديث تقدم الأفعى
                snake['progress'] += 1
                
                # إذا تجاوزت الأفعى المسار كاملاً (خرج الذيل كله)
                if snake['progress'] > NUM_LEDS + trail_length:
                    snakes_to_remove.append(snake)

            # إزالة الأفاعي المنتهية
            for snake in snakes_to_remove:
                active_snakes.remove(snake)

            # تطبيق التحديث على الشريط
            neo.update_strip()
            await asyncio.sleep(delay_per_step)

            global_frame += 1
            
            # إذا لم يكن هناك أفاعي نشطة ولم نطلب إطلاق المزيد، نكسر الدورة
            if not active_snakes and global_frame > next_spawn_time + 100:
                break

        # استراحة قصيرة بين الدورات
        if not stop_requested:
            await asyncio.sleep(1)

    # تنظيف بعد انتهاء اللوب
    neo.clear_strip()
    neo.update_strip()
