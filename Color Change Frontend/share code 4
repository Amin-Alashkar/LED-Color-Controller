async def meteor_shower_loop(delay_per_step: float = 0.08):
    """
    إصلاحات:
    - ضمان مسافة بين رؤوس الأفاعي: عشوائي بين 5 و15 LED (فعلياً مقاسة عند وقت الولادة)
    - الرأس يظهر أولاً عند index NUM_LEDS-1 ويتجه لليسار
    - الرأس أكثر سطوعاً، والذيل يتدرج تدريجياً للأغمق
    - سرعة مبدئية أخففتها (0.08s per step)
    متطلبات خارجية: NUM_LEDS, BRIGHTNESS_SCALE, neo, stop_requested
    """
    global stop_requested

    SNAKE_COLORS = [
        (255,   0,   0),   # أحمر
        (  0,   0, 255),   # أزرق
        (  0, 255,   0),   # أخضر
        (255, 255,   0),   # أصفر
        (255,   0, 255),   # أرجواني
        (  0, 255, 255),   # سماوي
        (255, 165,   0),   # برتقالي
        (255, 192, 203),   # وردي
        (138,  43, 226),   # بنفسجي
        ( 50, 205,  50)    # أخضر ليموني
    ]

    max_simultaneous_snakes = 50
    global_frame = 0
    next_spawn_frame = 0
    active_snakes = []
    snake_counter = 0

    def current_head_positions():
        """ترجع قائمة بمواقع رؤوس الأفاعي الحالية (قد تكون سلبية إذا خرجت)"""
        positions = []
        for s in active_snakes:
            pos = NUM_LEDS - 1 - s["progress"]
            positions.append(pos)
        return positions

    while not stop_requested:
        # احسب إذا يمكن إطلاق أفعى جديدة الآن مع ضمان المسافة المطلوبة
        if global_frame >= next_spawn_frame and len(active_snakes) < max_simultaneous_snakes:
            # طول الأفعى ولونها
            snake_length = random.randint(5, 15)
            color_base = random.choice(SNAKE_COLORS)
            # المسافة المطلوبة بين رؤوس الأفاعي (بالـ LEDs) - عشوائية بين 5 و15
            required_gap = random.randint(5, 15)
            # موقع الرأس الجديد عند الإطلاق سيكون NUM_LEDS-1
            new_head_pos = NUM_LEDS - 1

            # إذا في رؤوس حالية، احسب أقرب رأس موجود إلى الحافة اليمنى
            heads = current_head_positions()
            if heads:
                # أقرب رأس إلى الحافة اليمنى يعني أعلى قيمة لأن الحافة اليمنى هي NUM_LEDS-1
                nearest_head = max(heads)
                # المسافة الحالية بين الرأس الجديد و أقرب رأس موجود
                current_gap = new_head_pos - nearest_head
                if current_gap >= required_gap:
                    # نطلق الآن
                    spawn_now = True
                else:
                    # نحسب كم إطار نحتاج لننتظر حتى تكون المسافة كافية
                    # الرأس الحالي يتحرك 1 LED لكل إطار (progress++)
                    # نحتاج أن يبتعد الرأس الحالي عن الحافة اليمنى بمقدار (required_gap - current_gap)
                    frames_needed = required_gap - current_gap
                    next_spawn_frame = global_frame + frames_needed
                    spawn_now = False
            else:
                # لا أفاعي حالية => نطلق فوراً
                spawn_now = True

            if spawn_now:
                active_snakes.append({
                    "id": snake_counter,
                    "progress": 0,
                    "length": snake_length,
                    "color": color_base
                })
                snake_counter += 1
                # تحضير حد زمني احتياطي للإطلاق التالي — لكن الفاصل الحقيقي يتم حسابه أعلاه
                next_spawn_frame = global_frame + 1

        # رسم
        neo.clear_strip()

        for snake in active_snakes[:]:
            prog = snake["progress"]
            length = snake["length"]
            color_base = snake["color"]
            # الرأس يبدأ عند NUM_LEDS-1 عندما progress == 0
            head_pos = NUM_LEDS - 1 - prog

            # رسم الذيل: من الرأس (t=0) إلى الذيل (t=length-1)
            for t in range(length):
                pos = head_pos - t
                if 0 <= pos < NUM_LEDS:
                    # عامل التدرج: الرأس (t=0) = 1.0 (أكثر سطوعاً)
                    if length > 1:
                        factor = (length - 1 - t) / (length - 1)
                    else:
                        factor = 1.0
                    # نحتاج الرأس أن يكون الأكثر سطوعاً، لذلك نحسب brightness = 0.3 + 0.7*factor
                    # (اختياري) لكن هنا نستخدم factor مباشرة لتناقص خطي حتى الصِغَر جداً عند الذيل
                    r = int(color_base[0] * (factor if factor>0 else 0) * BRIGHTNESS_SCALE)
                    g = int(color_base[1] * (factor if factor>0 else 0) * BRIGHTNESS_SCALE)
                    b = int(color_base[2] * (factor if factor>0 else 0) * BRIGHTNESS_SCALE)
                    # إذا تريد الرأس أقوى نسبياً مقارنة بالذيل، يمكن استخدام:
                    # head_boost = 1.0 if t==0 else 1.0
                    neo.set_led_color(pos, r, g, b)

            # تحريك الأفعى خطوة لليسار
            snake["progress"] += 1

            # إزالة الأفعى إذا خرجت بالكامل (الرأس والذيل خارج الشريط)
            tail_pos = head_pos - (length - 1)
            if head_pos < 0 and tail_pos < 0:
                try:
                    active_snakes.remove(snake)
                except ValueError:
                    pass

        neo.update_strip()
        await asyncio.sleep(delay_per_step)
        global_frame += 1

    neo.clear_strip()
    neo.update_strip()
