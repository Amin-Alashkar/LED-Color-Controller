

# Safe removal with verification
[System.Security.Principal.WindowsIdentity]::GetCurrent().Name

if (Get-LocalUser -Name $UserName -ErrorAction SilentlyContinue) {
    Remove-LocalUser -Name $UserName
    Write-Host " User '$UserName' has been removed successfully!" -ForegroundColor Green
} else {
    Write-Host " User '$UserName' was not found or already removed." -ForegroundColor Yellow
}

# Safe removal with verification
$UserName = "tolfdir"

if (Get-LocalUser -Name $UserName -ErrorAction SilentlyContinue) {
    Remove-LocalUser -Name $UserName
    Write-Host " User '$UserName' has been removed successfully!" -ForegroundColor Green
} else {
    Write-Host " User '$UserName' was not found or already removed." -ForegroundColor Yellow
}


# Run as Administrator


Write-Host "`n=== APPLYING CRITICAL FIXES ===" -ForegroundColor Magenta

Write-Host "`n[1] CONFIGURING FIREWALL..." -ForegroundColor Yellow
try {
    # Completely reset and enable firewall
    Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
    Start-Service -Name "MpsSvc" -ErrorAction SilentlyContinue  # Windows Defender Firewall service
    Set-Service -Name "MpsSvc" -StartupType Automatic -ErrorAction SilentlyContinue
    Write-Host "‚úÖ FIREWALL COMPLETELY ENABLED" -ForegroundColor Green
} catch {
    Write-Host "‚ö†Ô∏è  Firewall configuration issue" -ForegroundColor Red
}

# 2. FIX PASSWORD POLICIES MANUALLY
Write-Host "`n[2] ENFORCING PASSWORD POLICIES..." -ForegroundColor Yellow
try {
    # Method 1: Using secedit with proper parameters
    $SecEditConfig = @"
[Unicode]
Unicode=yes
[Version]
signature=`"`$CHICAGO`$`
Revision=1
[System Access]
MinimumPasswordAge = 1
MaximumPasswordAge = 90
MinimumPasswordLength = 8
PasswordHistorySize = 5
LockoutBadCount = 10
ResetLockoutCount = 30
LockoutDuration = 30
[Registry Values]
MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\LimitBlankPasswordUse=4,1
MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\RestrictAnonymous=4,1
"@
    
    $SecEditConfig | Out-File "C:\secpol.cfg" -Encoding ASCII
    secedit /configure /db C:\Windows\security\local.sdb /cfg "C:\secpol.cfg" /areas SECURITYPOLICY /quiet
    Remove-Item "C:\secpol.cfg" -Force -ErrorAction SilentlyContinue
    Write-Host "‚úÖ PASSWORD POLICIES ENFORCED" -ForegroundColor Green
} catch {
    Write-Host "‚ö†Ô∏è  Password policies may need manual setup" -ForegroundColor Yellow
}

# 3. FIX SECURITY OPTIONS IN REGISTRY
Write-Host "`n[3] APPLYING SECURITY OPTIONS..." -ForegroundColor Yellow
$SecuritySettings = @(
    @{Path="HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"; Name="EnableLUA"; Value=1},
    @{Path="HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters"; Name="restrictnullsessaccess"; Value=1},
    @{Path="HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"; Name="LimitBlankPasswordUse"; Value=1},
    @{Path="HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"; Name="RestrictAnonymous"; Value=1},
    @{Path="HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"; Name="restrictanonymoussam"; Value=1}
)

foreach ($Setting in $SecuritySettings) {
    try {
        if (-not (Test-Path $Setting.Path)) { 
            New-Item -Path $Setting.Path -Force | Out-Null 
        }
        Set-ItemProperty -Path $Setting.Path -Name $Setting.Name -Value $Setting.Value -ErrorAction SilentlyContinue
        Write-Host "‚úÖ SECURITY: $($Setting.Name)" -ForegroundColor Green
    } catch {
        Write-Host "‚ö†Ô∏è  Failed: $($Setting.Name)" -ForegroundColor Yellow
    }
}

# 4. COMPREHENSIVE SOFTWARE REMOVAL
Write-Host "`n[4] DEEP SOFTWARE CLEANUP..." -ForegroundColor Yellow

# Remove all torrent and hacking tools completely
$UnwantedPatterns = @(
    "*torrent*", "*bittorrent*", "*wire shark*", "*wireshark*", "*brutus*", 
    "*hack*", "*crack*", "*keygen*", "*password*"
)

# Search and destroy in common locations
$SearchPaths = @(
    "$env:PROGRAMFILES",
    "$env:PROGRAMFILES(X86)", 
    "$env:USERPROFILE\Desktop",
    "$env:USERPROFILE\Downloads",
    "C:\Users\Public\Desktop",
    "C:\Users\Public\Downloads"
)

foreach ($Path in $SearchPaths) {
    foreach ($Pattern in $UnwantedPatterns) {
        Get-ChildItem -Path $Path -Recurse -Include "*$Pattern*" -ErrorAction SilentlyContinue | ForEach-Object {
            try {
                Remove-Item $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
                Write-Host "‚úÖ REMOVED: $($_.Name)" -ForegroundColor Green
            } catch {
                # Try alternate method
                try {
                    cmd /c "del /f /q `"$($_.FullName)`"" 2>$null
                } catch { }
            }
        }
    }
}

# 5. VERIFY AND FIX SERVICES
Write-Host "`n[5] VERIFYING SERVICES..." -ForegroundColor Yellow

# Ensure RDP is running (prevents -5 penalty)
$RequiredServices = @(
    @{Name="TermService"; DisplayName="Remote Desktop Services"; ShouldRun=$true},
    @{Name="UmRdpService"; DisplayName="Remote Desktop Services UserMode Port Redirector"; ShouldRun=$true}
)

$BadServices = @(
    @{Name="SMTPSVC"; DisplayName="SMTP"; ShouldRun=$false},
    @{Name="FTPSVC"; DisplayName="FTP"; ShouldRun=$false}
)

foreach ($Service in $RequiredServices) {
    try {
        Set-Service -Name $Service.Name -StartupType Automatic -ErrorAction SilentlyContinue
        Start-Service -Name $Service.Name -ErrorAction SilentlyContinue
        Write-Host "‚úÖ ENABLED: $($Service.DisplayName)" -ForegroundColor Green
    } catch {
        Write-Host "‚ö†Ô∏è  Could not enable: $($Service.DisplayName)" -ForegroundColor Yellow
    }
}

foreach ($Service in $BadServices) {
    try {
        Stop-Service -Name $Service.Name -Force -ErrorAction SilentlyContinue
        Set-Service -Name $Service.Name -StartupType Disabled -ErrorAction SilentlyContinue
        Write-Host "‚úÖ DISABLED: $($Service.DisplayName)" -ForegroundColor Green
    } catch {
        Write-Host "‚úÖ CONFIRMED: $($Service.DisplayName) already disabled" -ForegroundColor Green
    }
}

# 6. MANUAL CONFIGURATION CHECKLIST
Write-Host "   Open 'Local Security Policy' and verify:" -ForegroundColor Yellow
Write-Host "   ‚Ä¢ Password Policy ‚Üí Maximum password age = 90" -ForegroundColor White
Write-Host "   ‚Ä¢ Account Lockout Policy ‚Üí Threshold = 10" -ForegroundColor White
Write-Host "   ‚Ä¢ Security Options ‚Üí Blank password limit = Enabled" -ForegroundColor White
Write-Host "   ‚Ä¢ Security Options ‚Üí Anonymous enumeration = Disabled" -ForegroundColor White

Write-Host "`nüåê FIREWALL (WF.msc):" -ForegroundColor White
Write-Host "   Open 'Windows Defender Firewall' and verify:" -ForegroundColor Yellow
Write-Host "   ‚Ä¢ Domain Profile = ON" -ForegroundColor White
Write-Host "   ‚Ä¢ Private Profile = ON" -ForegroundColor White
Write-Host "   ‚Ä¢ Public Profile = ON" -ForegroundColor White

Write-Host "`nü¶ä FIREFOX UPDATE:" -ForegroundColor White
Write-Host "   ‚Ä¢ Open Firefox ‚Üí ‚ò∞ Menu ‚Üí Help ‚Üí About Firefox" -ForegroundColor Yellow
Write-Host "   ‚Ä¢ Click UPDATE and RESTART" -ForegroundColor Yellow

Write-Host "`nüìÅ FILE SHARES (fsmgmt.msc):" -ForegroundColor White
Write-Host "   ‚Ä¢ Open 'Shared Folders' ‚Üí Verify 'greybeard' is gone" -ForegroundColor Yellow

function Test-ScoringItem {
    param($Name, $Test, $Points)
    
    if (& $Test) {
        Write-Host "‚úÖ $Name - $Points points" -ForegroundColor Green
        return $Points
    } else {
        Write-Host "‚ùå $Name - 0 points" -ForegroundColor Red
        return 0
    }
}

$TotalScore = 0

Write-Host "`nSCORING BREAKDOWN:" -ForegroundColor Yellow

# Test each scoring category
$TotalScore += Test-ScoringItem "Unauthorized Users Removed" { 
    @("ancano", "tolfdir") | ForEach-Object { Get-LocalUser -Name $_ -ErrorAction SilentlyContinue } | Where-Object { $_ } | Measure-Object | Select-Object -ExpandProperty Count -eq 0
} 8

$TotalScore += Test-ScoringItem "Regular Users Not Admins" {
    $AuthorizedUsers = @("borri", "einarth", "wulfgar", "ulfric", "tullius", "ralof", "hadvar", "balgruuf", "farengar", "irileth", "lydia")
    ($AuthorizedUsers | ForEach-Object { 
        Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*$_*" }
    } | Measure-Object).Count -eq 0
} 5

$TotalScore += Test-ScoringItem "Firewall Enabled" {
    (Get-NetFirewallProfile | Where-Object { $_.Enabled -eq $true }).Count -eq 3
} 5

$TotalScore += Test-ScoringItem "Unauthorized Share Removed" {
    -not (Get-SmbShare -Name "greybeard" -ErrorAction SilentlyContinue)
} 6

$TotalScore += Test-ScoringItem "Services Disabled" {
    (@("SMTPSVC", "FTPSVC") | ForEach-Object { 
        (Get-Service -Name $_ -ErrorAction SilentlyContinue).StartType -eq 'Disabled'
    } | Where-Object { $_ } | Measure-Object).Count -eq 2
} 10
