# Admin credentials
ADMIN_USERNAME = "adminpanel"
ADMIN_PASSWORD = "RoomB107"

# Admin session management
app.add_middleware(SessionMiddleware, secret_key="your-very-secret-key-here")

# Admin login attempts tracking
login_attempts = {}
lockout_times = {}
login_lock = threading.Lock()

# Admin routes
@app.post("/admin/login")
async def admin_login(request: Request, 
                     username: str = Form(...), 
                     password: str = Form(...)):
    ip = request.client.host
    current_time = time.time()
    
    with login_lock:
        # Check if IP is currently locked out
        if ip in lockout_times and lockout_times[ip] > current_time:
            remaining = int(lockout_times[ip] - current_time)
            raise HTTPException(
                status_code=status.HTTP_429_TOO_MANY_REQUESTS,
                detail=f"Too many failed attempts. Please try again in {remaining} seconds."
            )
        
        # Check credentials
        if username == ADMIN_USERNAME and password == ADMIN_PASSWORD:
            # Reset failed attempts on successful login
            if ip in login_attempts:
                del login_attempts[ip]
            if ip in lockout_times:
                del lockout_times[ip]
                
            request.session["is_admin"] = True
            return {"status": "success"}
        else:
            # Increment failed attempt count
            login_attempts[ip] = login_attempts.get(ip, 0) + 1
            attempt_count = login_attempts[ip]
            
            # Calculate lockout parameters
            lockout_level = (attempt_count - 1) // 3
            lockout_duration = (2 ** lockout_level) * 60  # in seconds
            
            # If reached a multiple of 3, set lockout
            if attempt_count % 3 == 0:
                lockout_times[ip] = current_time + lockout_duration
                raise HTTPException(
                    status_code=status.HTTP_429_TOO_MANY_REQUESTS,
                    detail=f"Too many failed attempts. Account locked for {lockout_duration} seconds."
                )
            else:
                raise HTTPException(
                    status_code=status.HTTP_401_UNAUTHORIZED,
                    detail="Incorrect username or password"
                )

@app.get("/admin/status")
async def admin_status(request: Request):
    return {"is_admin": request.session.get("is_admin", False)}

@app.post("/admin/reset")
async def admin_reset(request: Request):
    if not request.session.get("is_admin"):
        raise HTTPException(status_code=403, detail="Forbidden")
    return {"message": "System reset complete"}

@app.post("/admin/reboot")
async def admin_reboot(request: Request):
    if not request.session.get("is_admin"):
        raise HTTPException(status_code=403, detail="Forbidden")
    return {"message": "System rebooting..."}

@app.post("/admin/shutdown")
async def admin_shutdown(request: Request):
    if not request.session.get("is_admin"):
        raise HTTPException(status_code=403, detail="Forbidden")
    return {"message": "System shutdown initiated"}

@app.post("/admin/logout")
async def admin_logout(request: Request):
    request.session.clear()
    return {"status": "success"}
