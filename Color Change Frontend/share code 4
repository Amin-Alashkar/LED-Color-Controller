import asyncio
import random

async def meteor_shower_loop(delay_per_step: float = 0.7):
    """
    أفاعي تتحرك من اليمين لليسار:
    - طول كل أفعى عشوائي حقيقي بين 5 و 15 (random.randint(5,15))
    - المسافة بين رؤوس الأفاعي عند الولادة عشوائية بين 5 و 15 (مضمونة)
    - الرأس أفتح، الذيل أغمق تدريجيًا (خطّي من 1.0 إلى 0.2)
    - سرعة افتراضية = 0.7s per frame (أبطأ كما طلبت)
    يعتمد على: NUM_LEDS, BRIGHTNESS_SCALE, neo, stop_requested
    """
    global stop_requested

    SNAKE_COLORS = [
        (255,   0,   0),
        (  0,   0, 255),
        (  0, 255,   0),
        (255, 255,   0),
        (255,   0, 255),
        (  0, 255, 255),
        (255, 165,   0),
        (255, 192, 203),
        (138,  43, 226),
        ( 50, 205,  50)
    ]

    max_simultaneous_snakes = 50
    global_frame = 0
    next_spawn_frame = 0
    active_snakes = []
    snake_counter = 0

    def current_head_positions():
        """ترجع مواقع رؤوس الأفاعي الحالية (قد تكون سالبة إذا خرجت)."""
        return [NUM_LEDS - 1 - s["progress"] for s in active_snakes]

    while not stop_requested:
        # محاولة إطلاق أفعى جديدة إذا وصلنا للوقت المناسب
        if global_frame >= next_spawn_frame and len(active_snakes) < max_simultaneous_snakes:
            # طول الأفعى عشوائي ومضمون بين 5 و15
            snake_length = random.randint(5, 15)
            color_base = random.choice(SNAKE_COLORS)
            required_gap = random.randint(5, 15)  # المسافة المطلوبة بين الرؤوس
            new_head_pos = NUM_LEDS - 1

            heads = current_head_positions()
            if heads:
                nearest_head = max(heads)  # أقرب رأس للحافة اليمنى
                current_gap = new_head_pos - nearest_head
                if current_gap >= required_gap:
                    spawn_now = True
                else:
                    frames_needed = required_gap - current_gap
                    # نظهر الأفعى بعد frames_needed إطار (كل إطار الرأس الحالي يتحرك لليسار بمقدار 1)
                    next_spawn_frame = global_frame + frames_needed
                    spawn_now = False
            else:
                spawn_now = True

            if spawn_now:
                active_snakes.append({
                    "id": snake_counter,
                    "progress": 0,
                    "length": snake_length,
                    "color": color_base
                })
                snake_counter += 1
                next_spawn_frame = global_frame + 1  # فاصل احتياطي

        # رسم الحالة الحالية
        neo.clear_strip()

        for snake in active_snakes[:]:
            prog = snake["progress"]
            length = snake["length"]
            color_base = snake["color"]

            # حساب موقع الرأس (progress=0 -> رأس عند NUM_LEDS-1)
            head_pos = NUM_LEDS - 1 - prog

            # رسم الذيل: t=0 => الرأس (الأكثر سطوعاً)
            for t in range(length):
                pos = head_pos - t
                if 0 <= pos < NUM_LEDS:
                    # عامل التدرج: الرأس => factor = 1.0 ; الذيل الأخير => factor = 0.0
                    if length > 1:
                        factor = (length - 1 - t) / (length - 1)  # في [0..1]
                    else:
                        factor = 1.0
                    # نحول factor إلى مستوى سطوع فعلي بين 0.2 و 1.0
                    brightness = 0.2 + 0.8 * factor  # رأس = 1.0 ، ذيل = 0.2
                    r = int(color_base[0] * brightness * BRIGHTNESS_SCALE)
                    g = int(color_base[1] * brightness * BRIGHTNESS_SCALE)
                    b = int(color_base[2] * brightness * BRIGHTNESS_SCALE)
                    neo.set_led_color(pos, r, g, b)

            # حرك الأفعى خطوة واحدة لليسار
            snake["progress"] += 1

            # إزالة الأفعى إذا خرجت بالكامل عن الشريط
            tail_pos = head_pos - (length - 1)
            if head_pos < 0 and tail_pos < 0:
                try:
                    active_snakes.remove(snake)
                except ValueError:
                    pass

        neo.update_strip()
        await asyncio.sleep(delay_per_step)
        global_frame += 1

    # عند الإيقاف ننظف الشريط
    neo.clear_strip()
    neo.update_strip()
